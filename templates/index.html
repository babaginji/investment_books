<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>投資本棚</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
    <h1>投資本棚</h1>

    <!-- 検索窓 -->
    <div id="search-panel">
        <input type="text" id="title" placeholder="本のタイトルを検索">
        <button onclick="searchBook()">検索</button>
    </div>

    <!-- 検索履歴ボックス -->
    <div id="search-history-box" style="display:none;"></div>

    <!-- 検索結果表示 -->
    <div id="search-results" class="books-container"></div>

    <!-- 棚リンク一覧 -->
    <h2>棚リンク一覧</h2>
    <div class="shelf-links">
        {% if "私の本棚" in shelves %}
        <div class="shelf-link">
            <a href="{{ url_for('shelf_page', shelf_name='私の本棚') }}">
                <img src="{{ url_for('static', filename='images/私の本棚.jpg') }}" alt="私の本棚">
                <p>私の本棚</p>
            </a>
        </div>
        {% endif %}

        {% for shelf in shelves %}
            {% if shelf != "私の本棚" %}
            <div class="shelf-link">
                <a href="{{ url_for('shelf_page', shelf_name=shelf) }}">
                    <img src="{{ url_for('static', filename='images/' + shelf + '.jpg') }}" alt="{{ shelf }}">
                    <p>{{ shelf }}</p>
                </a>
            </div>
            {% endif %}
        {% endfor %}
    </div>

    <!-- 検索結果（JSで生成する本カード） -->
    <div id="search-results" class="books-container"></div>
    <script>
        let searchResults = [];
        let myShelf = [];
        
        // -----------------------------
        // 本を検索
        // -----------------------------
        async function searchBook() {
            const titleInput = document.getElementById("title");
            const title = titleInput.value.trim();
            if (!title) return;
        
            const res = await fetch(`/search?title=${encodeURIComponent(title)}`);
            const books = await res.json();
            searchResults = books;
        
            addHistory(title);
            displaySearchResults();
        }
        
        // -----------------------------
        // 検索結果表示
        // -----------------------------
        function displaySearchResults() {
            const resultsDiv = document.getElementById("search-results");
            resultsDiv.innerHTML = "";
        
            searchResults.forEach(book => {
                const bookDiv = document.createElement("div");
                bookDiv.className = "book";
        
                // 星★
                const star = document.createElement("span");
                star.className = "star";
                star.textContent = myShelf.find(b => b.title === book.title) ? "★" : "☆";
                star.onclick = async (e) => {
                    e.stopPropagation();
                    if (star.textContent === "☆") {
                        const res = await fetch(`/add_to_my_shelf`, {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ book })
                        });
                        const data = await res.json();
                        myShelf = data.my_shelf;
                        star.textContent = "★";
                        displayMyShelf();
                    } else {
                        myShelf = myShelf.filter(b => b.title !== book.title);
                        await fetch(`/remove_from_my_shelf`, {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ title: book.title })
                        });
                        star.textContent = "☆";
                        displayMyShelf();
                    }
                };
        
                // 本カードHTML
                bookDiv.innerHTML = `
                    <div class="book-image-wrapper">
                        <img src="${book.image}" alt="${book.title}">
                    </div>
                    <span class="toggle-btn">詳細を見る</span>
                    <div class="book-details">
                        <p>価格: ¥${book.price}</p>
                        <p>図書館API: 仮情報</p>
                        <p>アマゾン関連情報: 仮情報</p>
                        <p>内容紹介: 仮情報</p>
                    </div>
                `;
        
                // 星★を画像ラッパーに追加
                bookDiv.querySelector(".book-image-wrapper").appendChild(star);
        
                // 詳細トグル
                const toggleBtn = bookDiv.querySelector(".toggle-btn");
                const detailsDiv = bookDiv.querySelector(".book-details");
                toggleBtn.addEventListener("click", () => {
                    if (detailsDiv.style.display === "none" || detailsDiv.style.display === "") {
                        detailsDiv.style.display = "block";
                        toggleBtn.textContent = "詳細を隠す";
                    } else {
                        detailsDiv.style.display = "none";
                        toggleBtn.textContent = "詳細を見る";
                    }
                });
        
                resultsDiv.appendChild(bookDiv);
            });
        }
        
        // -----------------------------
        // 「私の本棚」を表示
        // -----------------------------
        function displayMyShelf() {
            const myShelfDiv = document.getElementById("my-shelf-books");
            if (!myShelfDiv) return;
        
            myShelfDiv.innerHTML = "";
            myShelf.forEach(book => {
                const bookDiv = document.createElement("div");
                bookDiv.className = "book";
        
                // 星★
                const star = document.createElement("span");
                star.className = "star";
                star.textContent = "★";
                star.onclick = async (e) => {
                    e.stopPropagation();
                    myShelf = myShelf.filter(b => b.title !== book.title);
                    await fetch(`/remove_from_my_shelf`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ title: book.title })
                    });
                    displayMyShelf();
                    displaySearchResults();
                };
        
                // 本カードHTML
                bookDiv.innerHTML = `
                    <div class="book-image-wrapper">
                        <img src="${book.image}" alt="${book.title}">
                    </div>
                    <span class="toggle-btn">詳細を見る</span>
                    <div class="book-details">
                        <p>価格: ¥${book.price}</p>
                        <p>図書館API: 仮情報</p>
                        <p>アマゾン関連情報: 仮情報</p>
                        <p>内容紹介: 仮情報</p>
                    </div>
                `;
        
                bookDiv.querySelector(".book-image-wrapper").appendChild(star);
        
                // 詳細トグル
                const toggleBtn = bookDiv.querySelector(".toggle-btn");
                const detailsDiv = bookDiv.querySelector(".book-details");
                toggleBtn.addEventListener("click", () => {
                    if (detailsDiv.style.display === "none" || detailsDiv.style.display === "") {
                        detailsDiv.style.display = "block";
                        toggleBtn.textContent = "詳細を隠す";
                    } else {
                        detailsDiv.style.display = "none";
                        toggleBtn.textContent = "詳細を見る";
                    }
                });
        
                myShelfDiv.appendChild(bookDiv);
            });
        }
        
        // -----------------------------
// 検索履歴管理
// -----------------------------
function getHistory() {
    return JSON.parse(localStorage.getItem("searchHistory") || "[]");
}

function saveHistory(history) {
    localStorage.setItem("searchHistory", JSON.stringify(history));
}

function addHistory(title) {
    let history = getHistory();
    history = history.filter(item => item !== title);
    history.unshift(title);
    if (history.length > 20) history = history.slice(0, 20);
    saveHistory(history);
    displayHistory();
}

function deleteHistory(title) {
    let history = getHistory().filter(item => item !== title);
    saveHistory(history);
    displayHistory();
}

function displayHistory() {
    const box = document.getElementById("search-history-box");
    const input = document.getElementById("title");
    const history = getHistory();

    if (history.length === 0 || document.activeElement !== input) {
        box.style.display = "none";
        return;
    }

    // 検索窓と同じ幅・位置にする
    const rect = input.getBoundingClientRect();
    box.style.width = rect.width + "px";
    box.style.left = rect.left + "px";

    box.style.display = "block";

    box.innerHTML = "";
    history.forEach(item => {
        const div = document.createElement("div");
        div.className = "history-item";

        const span = document.createElement("span");
        span.className = "history-title";
        span.textContent = item;
        span.onclick = () => {
            input.value = item;
            searchBook();
        };

        const btn = document.createElement("button");
        btn.className = "delete-btn";
        btn.textContent = "×";
        btn.style.padding = "10px";
        btn.style.fontSize = "16px";
        btn.onclick = (e) => {
            e.stopPropagation();
            deleteHistory(item);
        };

        div.appendChild(span);
        div.appendChild(btn);
        box.appendChild(div);
    });
}

// inputイベントで履歴表示
const input = document.getElementById("title");
input.addEventListener("focus", displayHistory);
input.addEventListener("input", displayHistory);
input.addEventListener("blur", () => {
    setTimeout(() => { document.getElementById("search-history-box").style.display = "none"; }, 200);
});

        // -----------------------------
        // 初期ロード & イベント
        // -----------------------------
        async function loadMyShelf() {
            const res = await fetch(`/get_my_shelf`);
            const data = await res.json();
            myShelf = data.my_shelf || [];
            displayMyShelf();
        }
        
        window.onload = () => {
            loadMyShelf();
        
            const input = document.getElementById("title");
            const historyBox = document.getElementById("search-history-box");
        
            input.addEventListener("keydown", (e) => {
                if (e.key === "Enter") {
                    searchBook();
                    historyBox.style.display = "none";
                }
            });
        
            input.addEventListener("focus", () => displayHistory());
            input.addEventListener("input", () => displayHistory());
        
            historyBox.addEventListener("mousedown", (e) => e.preventDefault());
        
            input.addEventListener("blur", () => {
                setTimeout(() => { historyBox.style.display = "none"; }, 200);
            });
        };
        </script>
        
</body>
</html>
