<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>æŠ•è³‡æœ¬æ£š</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

</head>
<body>
    <!-- æ¤œç´¢çª“ + å±¥æ­´ãƒœãƒƒã‚¯ã‚¹ã‚’ã¾ã¨ã‚ã¦ãƒ©ãƒƒãƒ— -->
        <div id="search-wrapper" style="position: relative;">
            <div id="search-panel">
                <input type="text" id="title" placeholder="æœ¬ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ¤œç´¢">
                <button onclick="searchBook()">æ¤œç´¢</button>
            </div>
            <!-- æ¤œç´¢å±¥æ­´ãƒœãƒƒã‚¯ã‚¹ã¯ã“ã“ -->
            <div id="search-history-box" style="display:none; position: absolute; top: 100%; left: 0; width: 65%; margin: 0 8px 0 8px; z-index: 1000;"></div>
        </div>

        <!-- æ£šãƒªãƒ³ã‚¯ -->
        <div class="shelf-links">
            <div class="shelf-link">
                <a href="{{ url_for('shelf_page', shelf_name='ç§ã®æœ¬æ£š') }}">ç§ã®æœ¬æ£š</a>
            </div>
            {% for shelf in shelves %}
                {% if shelf != "ç§ã®æœ¬æ£š" %}
                <div class="shelf-link">
                    <a href="{{ url_for('shelf_page', shelf_name=shelf) }}">{{ shelf }}</a>
                </div>
                {% endif %}
            {% endfor %}
        </div>

        <!-- æ¤œç´¢çµæœè¡¨ç¤ºï¼ˆç«¯ã„ã£ã±ã„ã«åºƒã’ã‚‹ï¼‰ -->
        <div id="search-results-wrapper">
            <div id="search-results" class="books-container"></div>
        </div>
        <h2>é–²è¦§å±¥æ­´</h2>
        <div id="view-history-wrapper">
            <div id="view-history">
            <!-- .book ãŒä¸¦ã¶ -->
            </div>
        </div>
        <script>
            // -----------------------------
            // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
            // -----------------------------
            let searchResults = []; // ç¾åœ¨ã®æ¤œç´¢çµæœ
            let myShelf = [];       // ã€Œç§ã®æœ¬æ£šã€ã«ã‚ã‚‹æœ¬ã®ãƒªã‚¹ãƒˆ
        
            // -----------------------------
            // localStorage é–¢é€£é–¢æ•°
            // -----------------------------
            function saveShelfLocal() {
                localStorage.setItem("myShelf", JSON.stringify(myShelf));
            }
        
            function loadShelfLocal() {
                return JSON.parse(localStorage.getItem("myShelf") || "[]");
            }
        
            // -----------------------------
            // æ¤œç´¢å±¥æ­´ç®¡ç†
            // -----------------------------
            function getHistory() {
                return JSON.parse(localStorage.getItem("searchHistory") || "[]");
            }
        
            function saveHistory(history) {
                localStorage.setItem("searchHistory", JSON.stringify(history));
            }
        
            function addHistory(title) {
                let history = getHistory();
                history = history.filter(item => item !== title);
                history.unshift(title);
                if (history.length > 20) history = history.slice(0, 20);
                saveHistory(history);
                displayHistory();
            }
        
            function deleteHistory(title) {
                let history = getHistory().filter(item => item !== title);
                saveHistory(history);
                displayHistory();
            }
        
            function displayHistory() {
                const box = document.getElementById("search-history-box");
                const input = document.getElementById("title");
                const history = getHistory();
        
                if (history.length === 0 || document.activeElement !== input) {
                    box.style.display = "none";
                    return;
                }
        
                box.style.display = "block";
                box.innerHTML = "";
        
                history.forEach(item => {
                    const div = document.createElement("div");
                    div.className = "history-item";
        
                    const span = document.createElement("span");
                    span.className = "history-title";
                    span.textContent = item;
                    span.onclick = () => {
                        input.value = item;
                        searchBook();
                        box.style.display = "none";
                    };
        
                    const btn = document.createElement("button");
                    btn.className = "delete-btn";
                    btn.textContent = "Ã—";
                    btn.onclick = (e) => {
                        e.stopPropagation();
                        deleteHistory(item);
                    };
        
                    div.appendChild(span);
                    div.appendChild(btn);
                    box.appendChild(div);
                });
            }
        
            // -----------------------------
            // ã€Œç§ã®æœ¬æ£šã€è¡¨ç¤º
            // -----------------------------
            function updateMyShelfDisplay() {
                const shelfDiv = document.getElementById("my-shelf-books");
                if (!shelfDiv) return;
                shelfDiv.innerHTML = "";
        
                myShelf.forEach(book => {
                    const bookDiv = document.createElement("div");
                    bookDiv.className = "book";
        
                    const star = document.createElement("span");
                    star.className = "star";
                    star.textContent = "â˜…";
                    star.style.cursor = "pointer";
                    star.onclick = () => {
                        const index = myShelf.findIndex(b => b.title === book.title);
                        if (index !== -1) myShelf.splice(index, 1);
                        saveShelfLocal();
                        updateMyShelfDisplay();
                        displaySearchResults();
                    };
        
                    const imgLink = document.createElement("a");
                    imgLink.href = book.itemUrl;
                    imgLink.target = "_blank";
        
                    const img = document.createElement("img");
                    img.src = book.image;
                    img.alt = book.title;
                    imgLink.appendChild(img);
        
                    bookDiv.appendChild(imgLink);
                    bookDiv.appendChild(star);
        
                    const details = document.createElement("div");
                    details.className = "book-details";
                    details.innerHTML = `
                        <p>ä¾¡æ ¼: Â¥${book.price}</p>
                        <p>è‘—è€…: ${book.author}</p>
                    `;
                    bookDiv.appendChild(details);
        
                    shelfDiv.appendChild(bookDiv);
                });
            }
        
            // -----------------------------
            // æœ¬æ¤œç´¢ã®çµæœã‚’çµ±ä¸€å½¢å¼ã«å¤‰æ›
            // -----------------------------
            function normalizeBook(rawBook) {
                return {
                    title: rawBook.title || "",
                    author: rawBook.author || "",
                    price: rawBook.price || "æƒ…å ±ãªã—",
                    image: rawBook.image || rawBook.cover || "",
                    itemUrl: rawBook.itemUrl || rawBook.url || "#",
                    isbn: rawBook.isbn || "",
                };
            }
        
            // -----------------------------
            // å‘¨è¾ºå›³æ›¸é¤¨æƒ…å ±å–å¾—
            // -----------------------------
            async function fetchLibraryInfo(bookTitle, containerDiv) {
                if (!navigator.geolocation) {
                    containerDiv.innerHTML = "<p>ä½ç½®æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã€‚</p>";
                    return;
                }
        
                navigator.geolocation.getCurrentPosition(async (position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
        
                    const res = await fetch(`/library?title=${encodeURIComponent(bookTitle)}&lat=${lat}&lon=${lon}`);
                    const libraries = await res.json();
        
                    if (!libraries || libraries.length === 0) {
                        containerDiv.innerHTML = "<p>è¿‘ãã®å›³æ›¸é¤¨ã§åœ¨åº«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>";
                        return;
                    }
        
                    libraries.sort((a,b) => a.distance - b.distance);
                    containerDiv.innerHTML = "";
                    libraries.forEach(lib => {
                        const div = document.createElement("div");
                        div.className = "library-item";
                        div.innerHTML = `<p>ğŸ“š ${lib.name} (${lib.distance.toFixed(1)} km)</p><p>åœ¨åº«: ${lib.stock}</p>`;
                        containerDiv.appendChild(div);
                    });
                }, (err) => {
                    containerDiv.innerHTML = "<p>ä½ç½®æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>";
                });
            }
        
            // -----------------------------
            // æ¤œç´¢çµæœè¡¨ç¤º
            // -----------------------------
            function displaySearchResults() {
                const resultsDiv = document.getElementById("search-results");
                if (!resultsDiv) return;
                resultsDiv.innerHTML = "";
        
                searchResults.forEach(rawBook => {
                    const book = normalizeBook(rawBook);
        
                    const bookDiv = document.createElement("div");
                    bookDiv.className = "book";
        
                    const star = document.createElement("span");
                    star.className = "star";
                    star.textContent = myShelf.find(b => b.title === book.title) ? "â˜…" : "â˜†";
                    star.style.cursor = "pointer";
                    star.onclick = () => {
                        const index = myShelf.findIndex(b => b.title === book.title);
                        if (index === -1) myShelf.push(book);
                        else myShelf.splice(index, 1);
                        saveShelfLocal();
                        updateMyShelfDisplay();
                        displaySearchResults();
                    };
        
                    const imgLink = document.createElement("a");
                    imgLink.href = book.itemUrl;
                    imgLink.target = "_blank";
                    imgLink.onclick = () => addToViewHistory(book);
        
                    const img = document.createElement("img");
                    img.src = book.image;
                    img.alt = book.title;
                    imgLink.appendChild(img);
        
                    bookDiv.appendChild(imgLink);
                    bookDiv.appendChild(star);
        
                    const detailsDiv = document.createElement("div");
                    detailsDiv.className = "book-details";
                    detailsDiv.style.display = "none";
                    detailsDiv.innerHTML = `<p>ä¾¡æ ¼: ${book.price}</p><p>è‘—è€…: ${book.author}</p>`;
                    bookDiv.appendChild(detailsDiv);
        
                    // â†ã“ã“ã§å›³æ›¸é¤¨æƒ…å ±ç”¨ div ã‚’è¿½åŠ 
                    const libraryDiv = document.createElement("div");
                    libraryDiv.className = "library-info";
                    libraryDiv.style.display = "none";
                    bookDiv.appendChild(libraryDiv);
        
                    const toggleBtn = document.createElement("span");
                    toggleBtn.className = "toggle-btn";
                    toggleBtn.textContent = "è©³ç´°ã‚’è¦‹ã‚‹";
                    toggleBtn.onclick = () => {
                        if (detailsDiv.style.display === "none") {
                            detailsDiv.style.display = "block";
                            libraryDiv.style.display = "block";
                            toggleBtn.textContent = "è©³ç´°ã‚’éš ã™";
                            fetchLibraryInfo(book.title, libraryDiv);
                        } else {
                            detailsDiv.style.display = "none";
                            libraryDiv.style.display = "none";
                            toggleBtn.textContent = "è©³ç´°ã‚’è¦‹ã‚‹";
                        }
                    };
                    bookDiv.appendChild(toggleBtn);
        
                    resultsDiv.appendChild(bookDiv);
                });
            }
        
            // -----------------------------
            // é–²è¦§å±¥æ­´æ©Ÿèƒ½
            // -----------------------------
            function addToViewHistory(book) {
                let history = JSON.parse(localStorage.getItem("viewHistory") || "[]");
        
                if (!history.find(b => b.title === book.title)) {
                    history.unshift(book);
                    if (history.length > 20) history.pop();
                }
        
                localStorage.setItem("viewHistory", JSON.stringify(history));
                displayViewHistory();
            }
        
            function displayViewHistory() {
                const historyDiv = document.getElementById("view-history");
                if (!historyDiv) return;
                historyDiv.innerHTML = "";
        
                const history = JSON.parse(localStorage.getItem("viewHistory") || "[]");
        
                history.forEach(book => {
                    const bookDiv = document.createElement("div");
                    bookDiv.className = "book";
        
                    const imgLink = document.createElement("a");
                    imgLink.href = book.itemUrl;
                    imgLink.target = "_blank";
        
                    const img = document.createElement("img");
                    img.src = book.image;
                    img.alt = book.title;
        
                    imgLink.appendChild(img);
                    bookDiv.appendChild(imgLink);
        
                    const detailsDiv = document.createElement("div");
                    detailsDiv.className = "book-details";
                    detailsDiv.innerHTML = `<p>ä¾¡æ ¼: Â¥${book.price}</p><p>è‘—è€…: ${book.author}</p>`;
                    bookDiv.appendChild(detailsDiv);
        
                    historyDiv.appendChild(bookDiv);
                });
            }
        
            // -----------------------------
            // æœ¬ã‚’æ¤œç´¢
            // -----------------------------
            async function searchBook() {
                const titleInput = document.getElementById("title");
                const title = titleInput.value.trim();
                if (!title) return;
        
                const res = await fetch(`/search?title=${encodeURIComponent(title)}`);
                const books = await res.json();
                searchResults = books;
        
                addHistory(title);
                localStorage.setItem("lastSearch", JSON.stringify({ title, books }));
                displaySearchResults();
            }
        
            // -----------------------------
            // åˆæœŸãƒ­ãƒ¼ãƒ‰
            // -----------------------------
            window.onload = () => {
                myShelf = loadShelfLocal();
                updateMyShelfDisplay();
        
                const input = document.getElementById("title");
                const historyBox = document.getElementById("search-history-box");
        
                const lastSearch = localStorage.getItem("lastSearch");
                if (lastSearch) {
                    const data = JSON.parse(lastSearch);
                    input.value = data.title;
                    searchResults = data.books;
                    displaySearchResults();
                }
        
                input.addEventListener("keydown", (e) => {
                    if (e.key === "Enter") searchBook();
                });
        
                input.addEventListener("focus", () => displayHistory());
                input.addEventListener("input", () => displayHistory());
        
                historyBox.addEventListener("mousedown", (e) => e.preventDefault());
        
                document.addEventListener("click", (e) => {
                    if (!input.contains(e.target) && !historyBox.contains(e.target)) {
                        historyBox.style.display = "none";
                    }
                });
        
                displayViewHistory();
            };
        </script>
        
</body>
</html>
