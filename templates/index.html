<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title></title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
    <h1></h1>

    <!-- 検索窓 -->
    <div id="search-panel">
        <input type="text" id="title" placeholder="本のタイトルを検索">
        <button onclick="searchBook()">検索</button>
    </div>

    <!-- 検索履歴ボックス -->
    <div id="search-history-box" style="display:none;"></div>

    <!-- 検索結果表示（端いっぱいに広げる） -->
    <div id="search-results-wrapper">
        <div id="search-results" class="books-container"></div>
    </div>

    <!-- 「私の本棚」リンク（特別枠） -->
    <h2>私の本棚</h2>
    <div class="my-shelf-link">
        <a href="{{ url_for('shelf_page', shelf_name='私の本棚') }}">私の本棚</a>
    </div>

    <!-- その他の棚リンク（横スクロールで選択） -->
    <h2>棚リンク一覧</h2>
    <div class="shelf-links">
        {% for shelf in shelves %}
            {% if shelf != "私の本棚" %}
            <div class="shelf-link">
                <a href="{{ url_for('shelf_page', shelf_name=shelf) }}">{{ shelf }}</a>
            </div>
        {% endif %}
    {% endfor %}
</div>

    <script>
        let searchResults = [];
        let myShelf = [];
    
        // -----------------------------
        // 本棚データを localStorage に保存
        // -----------------------------
        function saveShelfLocal() {
            localStorage.setItem("myShelf", JSON.stringify(myShelf));
        }
    
        function loadShelfLocal() {
            return JSON.parse(localStorage.getItem("myShelf") || "[]");
        }
    
        // -----------------------------
        // 本を検索
        // -----------------------------
        async function searchBook() {
            const titleInput = document.getElementById("title");
            const title = titleInput.value.trim();
            if (!title) return;
    
            const res = await fetch(`/search?title=${encodeURIComponent(title)}`);
            const books = await res.json();
            searchResults = books;
    
            // 検索履歴 & 検索結果保存
            localStorage.setItem("lastSearch", JSON.stringify({
                title: title,
                books: books
            }));
    
            addHistory(title);
            displaySearchResults();
        }
    
        // -----------------------------
        // 検索結果表示
        // -----------------------------
        function displaySearchResults() {
            const resultsDiv = document.getElementById("search-results");
            resultsDiv.innerHTML = "";
    
            searchResults.forEach(book => {
                const bookDiv = document.createElement("div");
                bookDiv.className = "book";
    
                // 星★
                const star = document.createElement("span");
                star.className = "star";
                star.dataset.title = book.title;
                star.textContent = myShelf.find(b => b.title === book.title) ? "★" : "☆";
                star.onclick = () => toggleStar(book);
    
                // 画像リンク
                const imgLink = document.createElement("a");
                imgLink.href = book.itemUrl;
                imgLink.target = "_blank";
    
                const img = document.createElement("img");
                img.src = book.image;
                img.alt = book.title;
                imgLink.appendChild(img);
    
                const imgWrapper = document.createElement("div");
                imgWrapper.className = "book-image-wrapper";
                imgWrapper.appendChild(imgLink);
                imgWrapper.appendChild(star);
    
                bookDiv.appendChild(imgWrapper);
    
                // 詳細情報
                const detailsDiv = document.createElement("div");
                detailsDiv.className = "book-details";
                detailsDiv.style.display = "none";
                detailsDiv.innerHTML = `
                    <p>価格: ¥${book.price}</p>
                    <p>図書館API: 仮情報</p>
                    <p>アマゾン関連情報: 仮情報</p>
                    <p>内容紹介: 仮情報</p>
                `;
    
                const toggleBtn = document.createElement("span");
                toggleBtn.className = "toggle-btn";
                toggleBtn.textContent = "詳細を見る";
                toggleBtn.addEventListener("click", () => {
                    if (detailsDiv.style.display === "none") {
                        detailsDiv.style.display = "block";
                        toggleBtn.textContent = "詳細を隠す";
                    } else {
                        detailsDiv.style.display = "none";
                        toggleBtn.textContent = "詳細を見る";
                    }
                });
    
                bookDiv.appendChild(toggleBtn);
                bookDiv.appendChild(detailsDiv);
    
                resultsDiv.appendChild(bookDiv);
            });
        }
    
        // -----------------------------
        // 「私の本棚」を表示
        // -----------------------------
        function displayMyShelf() {
            const myShelfDiv = document.getElementById("my-shelf-books");
            if (!myShelfDiv) return;
    
            myShelfDiv.innerHTML = "";
            myShelf.forEach(book => {
                const bookDiv = document.createElement("div");
                bookDiv.className = "book";
    
                const star = document.createElement("span");
                star.className = "star";
                star.dataset.title = book.title;
                star.textContent = "★";
                star.onclick = () => toggleStar(book);
    
                const imgLink = document.createElement("a");
                imgLink.href = book.itemUrl;
                imgLink.target = "_blank";
    
                const img = document.createElement("img");
                img.src = book.image;
                img.alt = book.title;
                imgLink.appendChild(img);
    
                const imgWrapper = document.createElement("div");
                imgWrapper.className = "book-image-wrapper";
                imgWrapper.appendChild(imgLink);
                imgWrapper.appendChild(star);
    
                bookDiv.appendChild(imgWrapper);
    
                const detailsDiv = document.createElement("div");
                detailsDiv.className = "book-details";
                detailsDiv.style.display = "none";
                detailsDiv.innerHTML = `
                    <p>価格: ¥${book.price}</p>
                    <p>図書館API: 仮情報</p>
                    <p>アマゾン関連情報: 仮情報</p>
                    <p>内容紹介: 仮情報</p>
                `;
    
                const toggleBtn = document.createElement("span");
                toggleBtn.className = "toggle-btn";
                toggleBtn.textContent = "詳細を見る";
                toggleBtn.addEventListener("click", () => {
                    if (detailsDiv.style.display === "none") {
                        detailsDiv.style.display = "block";
                        toggleBtn.textContent = "詳細を隠す";
                    } else {
                        detailsDiv.style.display = "none";
                        toggleBtn.textContent = "詳細を見る";
                    }
                });
    
                bookDiv.appendChild(toggleBtn);
                bookDiv.appendChild(detailsDiv);
    
                myShelfDiv.appendChild(bookDiv);
            });
        }
    
        // -----------------------------
        // 星の ON/OFF を共通処理に
        // -----------------------------
        async function toggleStar(book) {
            const exists = myShelf.find(b => b.title === book.title);
            if (!exists) {
                // 追加
                const res = await fetch(`/add_to_my_shelf`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ book })
                });
                const data = await res.json();
                myShelf = data.my_shelf;
            } else {
                // 削除
                await fetch(`/remove_from_my_shelf`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ title: book.title })
                });
                myShelf = myShelf.filter(b => b.title !== book.title);
            }
            saveShelfLocal();
            displayMyShelf();
            displaySearchResults();
        }
    
        // -----------------------------
        // 検索履歴管理
        // -----------------------------
        function getHistory() {
            return JSON.parse(localStorage.getItem("searchHistory") || "[]");
        }
    
        function saveHistory(history) {
            localStorage.setItem("searchHistory", JSON.stringify(history));
        }
    
        function addHistory(title) {
            let history = getHistory();
            history = history.filter(item => item !== title);
            history.unshift(title);
            if (history.length > 20) history = history.slice(0, 20);
            saveHistory(history);
            displayHistory();
        }
    
        function deleteHistory(title) {
            let history = getHistory().filter(item => item !== title);
            saveHistory(history);
            displayHistory();
        }
    
        function displayHistory() {
            const box = document.getElementById("search-history-box");
            const input = document.getElementById("title");
            const history = getHistory();
    
            if (history.length === 0 || document.activeElement !== input) {
                box.style.display = "none";
                return;
            }
    
            const rect = input.getBoundingClientRect();
            box.style.width = rect.width + "px";
            box.style.left = rect.left + "px";
    
            box.style.display = "block";
            box.innerHTML = "";
    
            history.forEach(item => {
                const div = document.createElement("div");
                div.className = "history-item";
    
                const span = document.createElement("span");
                span.className = "history-title";
                span.textContent = item;
                span.onclick = () => {
                    input.value = item;
                    searchBook();
                };
    
                const btn = document.createElement("button");
                btn.className = "delete-btn";
                btn.textContent = "×";
                btn.onclick = (e) => {
                    e.stopPropagation();
                    deleteHistory(item);
                };
    
                div.appendChild(span);
                div.appendChild(btn);
                box.appendChild(div);
            });
        }
    
        // -----------------------------
        // 初期ロード & イベント
        // -----------------------------
        async function loadMyShelf() {
            try {
                const res = await fetch(`/get_my_shelf`);
                const data = await res.json();
                myShelf = data.my_shelf || [];
            } catch {
                myShelf = loadShelfLocal();
            }
            displayMyShelf();
        }
    
        window.onload = () => {
            loadMyShelf();
    
            const input = document.getElementById("title");
            const historyBox = document.getElementById("search-history-box");
    
            // ページロード時に検索結果を復元
            const lastSearch = localStorage.getItem("lastSearch");
            if (lastSearch) {
                const data = JSON.parse(lastSearch);
                input.value = data.title;
                searchResults = data.books;
                displaySearchResults();
            }
    
            input.addEventListener("keydown", (e) => {
                if (e.key === "Enter") {
                    searchBook();
                    historyBox.style.display = "none";
                }
            });
    
            input.addEventListener("focus", () => displayHistory());
            input.addEventListener("input", () => displayHistory());
    
            historyBox.addEventListener("mousedown", (e) => e.preventDefault());
    
            input.addEventListener("blur", () => {
                setTimeout(() => { historyBox.style.display = "none"; }, 200);
            });
        };
    </script>
    
</body>
</html>
