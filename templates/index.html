<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>投資本棚</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

</head>
<body>
    <!-- 検索窓 -->
    <div id="search-panel">
        <input type="text" id="title" placeholder="本のタイトルを検索">
        <button onclick="searchBook()">検索</button>
    </div>

    <!-- 棚リンク（先頭に私の本棚を含む） -->
    <div class="shelf-links">
        <div class="shelf-link">
            <a href="{{ url_for('shelf_page', shelf_name='私の本棚') }}">私の本棚</a>
        </div>
        {% for shelf in shelves %}
            {% if shelf != "私の本棚" %}
            <div class="shelf-link">
                <a href="{{ url_for('shelf_page', shelf_name=shelf) }}">{{ shelf }}</a>
            </div>
            {% endif %}
        {% endfor %}
    </div>

    <!-- 検索履歴ボックス -->
    <div id="search-history-box" style="display:none;"></div>

    <!-- 検索結果表示（端いっぱいに広げる） -->
    <div id="search-results-wrapper">
        <div id="search-results" class="books-container"></div>
    </div>
    <script>
        let searchResults = [];
        let myShelf = [];
        
        // -----------------------------
        // localStorage 永続化
        // -----------------------------
        function saveShelfLocal() {
            localStorage.setItem("myShelf", JSON.stringify(myShelf));
        }
        
        function loadShelfLocal() {
            return JSON.parse(localStorage.getItem("myShelf") || "[]");
        }
        
        // -----------------------------
        // 「私の本棚」を画面に表示
        // -----------------------------
        function updateMyShelfDisplay() {
            const shelfDiv = document.getElementById("my-shelf-books");
            if (!shelfDiv) return;
            shelfDiv.innerHTML = "";
        
            myShelf.forEach(book => {
                const bookDiv = document.createElement("div");
                bookDiv.className = "book";
        
                const star = document.createElement("span");
                star.className = "star";
                star.textContent = "★";
                star.style.cursor = "pointer";
                star.onclick = () => {
                    // 削除
                    const index = myShelf.findIndex(b => b.title === book.title);
                    if (index !== -1) myShelf.splice(index, 1);
                    saveShelfLocal();
                    updateMyShelfDisplay();
                    displaySearchResults(); // 検索結果の★も更新
                };
        
                const imgLink = document.createElement("a");
                imgLink.href = book.itemUrl;
                imgLink.target = "_blank";
        
                const img = document.createElement("img");
                img.src = book.image;
                img.alt = book.title;
                imgLink.appendChild(img);
        
                bookDiv.appendChild(imgLink);
                bookDiv.appendChild(star);
        
                const details = document.createElement("div");
                details.className = "book-details";
                details.innerHTML = `
                    <p>価格: ¥${book.price}</p>
                    <p>著者: ${book.author}</p>
                `;
                bookDiv.appendChild(details);
        
                shelfDiv.appendChild(bookDiv);
            });
        }
        
        // -----------------------------
        // 検索結果表示
        // -----------------------------
        function displaySearchResults() {
            const resultsDiv = document.getElementById("search-results");
            if (!resultsDiv) return;
            resultsDiv.innerHTML = "";
        
            searchResults.forEach(book => {
                const bookDiv = document.createElement("div");
                bookDiv.className = "book";
        
                const star = document.createElement("span");
                star.className = "star";
                star.textContent = myShelf.find(b => b.title === book.title) ? "★" : "☆";
                star.style.cursor = "pointer";
                star.onclick = () => {
                    const index = myShelf.findIndex(b => b.title === book.title);
                    if (index === -1) {
                        myShelf.push(book);
                    } else {
                        myShelf.splice(index, 1);
                    }
                    saveShelfLocal();
                    updateMyShelfDisplay();
                    displaySearchResults();
                };
        
                const imgLink = document.createElement("a");
                imgLink.href = book.itemUrl;
                imgLink.target = "_blank";
        
                const img = document.createElement("img");
                img.src = book.image;
                img.alt = book.title;
                imgLink.appendChild(img);
        
                bookDiv.appendChild(imgLink);
                bookDiv.appendChild(star);
        
                const detailsDiv = document.createElement("div");
                detailsDiv.className = "book-details";
                detailsDiv.style.display = "none";
                detailsDiv.innerHTML = `
                    <p>価格: ¥${book.price}</p>
                    <p>著者: ${book.author}</p>
                    <p>内容紹介: 仮情報</p>
                `;
                bookDiv.appendChild(detailsDiv);
        
                const toggleBtn = document.createElement("span");
                toggleBtn.className = "toggle-btn";
                toggleBtn.textContent = "詳細を見る";
                toggleBtn.onclick = () => {
                    if (detailsDiv.style.display === "none") {
                        detailsDiv.style.display = "block";
                        toggleBtn.textContent = "詳細を隠す";
                    } else {
                        detailsDiv.style.display = "none";
                        toggleBtn.textContent = "詳細を見る";
                    }
                };
                bookDiv.appendChild(toggleBtn);
        
                resultsDiv.appendChild(bookDiv);
            });
        }
        
        // -----------------------------
        // 本を検索
        // -----------------------------
        async function searchBook() {
            const titleInput = document.getElementById("title");
            const title = titleInput.value.trim();
            if (!title) return;
        
            const res = await fetch(`/search?title=${encodeURIComponent(title)}`);
            const books = await res.json();
            searchResults = books;
        
            // 検索履歴と検索結果を保存
            localStorage.setItem("lastSearch", JSON.stringify({ title, books }));
        
            displaySearchResults();
        }
        
        // -----------------------------
        // 初期ロード
        // -----------------------------
        window.onload = () => {
            myShelf = loadShelfLocal();
            updateMyShelfDisplay();
        
            const input = document.getElementById("title");
        
            const lastSearch = localStorage.getItem("lastSearch");
            if (lastSearch) {
                const data = JSON.parse(lastSearch);
                input.value = data.title;
                searchResults = data.books;
                displaySearchResults();
            }
        
            input.addEventListener("keydown", (e) => {
                if (e.key === "Enter") searchBook();
            });
        };
        </script>
        
</body>
</html>
