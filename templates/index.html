<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>æŠ•è³‡æœ¬æ£š</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

</head>
<body>
    <!-- æ¤œç´¢çª“ + å±¥æ­´ãƒœãƒƒã‚¯ã‚¹ã‚’ã¾ã¨ã‚ã¦ãƒ©ãƒƒãƒ— -->
        <div id="search-wrapper" style="position: relative;">
            <div id="search-panel">
                <input type="text" id="title" placeholder="æœ¬ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ¤œç´¢">
                <button onclick="searchBook()">æ¤œç´¢</button>
            </div>
            <!-- æ¤œç´¢å±¥æ­´ãƒœãƒƒã‚¯ã‚¹ã¯ã“ã“ -->
            <div id="search-history-box" style="display:none; position: absolute; top: 100%; left: 0; width: 65%; margin: 0 8px 0 8px; z-index: 1000;"></div>
        </div>

        <!-- æ£šãƒªãƒ³ã‚¯ -->
        <div class="shelf-links">
            <div class="shelf-link">
                <a href="{{ url_for('shelf_page', shelf_name='ç§ã®æœ¬æ£š') }}">ç§ã®æœ¬æ£š</a>
            </div>
            {% for shelf in shelves %}
                {% if shelf != "ç§ã®æœ¬æ£š" %}
                <div class="shelf-link">
                    <a href="{{ url_for('shelf_page', shelf_name=shelf) }}">{{ shelf }}</a>
                </div>
                {% endif %}
            {% endfor %}
        </div>

        <!-- æ¤œç´¢çµæœè¡¨ç¤ºï¼ˆç«¯ã„ã£ã±ã„ã«åºƒã’ã‚‹ï¼‰ -->
        <div id="search-results-wrapper">
            <div id="search-results" class="books-container"></div>
        </div>
        <div class="library-section">
            <!-- ä¸Šæ®µï¼šè¦‹å‡ºã— + ãƒªãƒ¼ã‚«ãƒ«ãƒªãƒ³ã‚¯ -->
        <div id="nearby-libraries-wrapper">
            <div class="library-header">
                <h2>è¿‘ãã®å›³æ›¸é¤¨</h2>
                <a href="https://calil.jp/" target="_blank" class="library-link">ã‚«ãƒ¼ãƒªãƒ«æ¤œç´¢</a>
            </div>
        </div>
            <!-- ä¸‹æ®µï¼šå›³æ›¸é¤¨ãƒªãƒ³ã‚¯ -->
            <div id="library-results" class="library-links-container"></div>
        </div>
        
        
        
        <h2>é–²è¦§å±¥æ­´</h2>
        <div id="view-history-wrapper">
            <div id="view-history">
            <!-- .book ãŒä¸¦ã¶ -->
            </div>
        </div>
        <h2>ã‚ãªãŸã«ãŠã™ã™ã‚</h2>
        <div id="recommend-books" class="books-container"></div>
        
            
        <script>
            // -----------------------------
            // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
            // -----------------------------
            let searchResults = []; // ç¾åœ¨ã®æ¤œç´¢çµæœ
            let myShelf = [];       // ã€Œç§ã®æœ¬æ£šã€ã«ã‚ã‚‹æœ¬ã®ãƒªã‚¹ãƒˆ
        
            // -----------------------------
            // localStorage é–¢é€£é–¢æ•°
            // -----------------------------
            function saveShelfLocal() {
                localStorage.setItem("myShelf", JSON.stringify(myShelf));
            }
        
            function loadShelfLocal() {
                return JSON.parse(localStorage.getItem("myShelf") || "[]");
            }
        
            // -----------------------------
            // æ¤œç´¢å±¥æ­´ç®¡ç†
            // -----------------------------
            function getHistory() {
                return JSON.parse(localStorage.getItem("searchHistory") || "[]");
            }
        
            function saveHistory(history) {
                localStorage.setItem("searchHistory", JSON.stringify(history));
            }
        
            function addHistory(title) {
                let history = getHistory();
                history = history.filter(item => item !== title);
                history.unshift(title);
                if (history.length > 20) history = history.slice(0, 20);
                saveHistory(history);
                displayHistory();
            }
        
            function deleteHistory(title) {
                let history = getHistory().filter(item => item !== title);
                saveHistory(history);
                displayHistory();
            }
        
            function displayHistory() {
                const box = document.getElementById("search-history-box");
                const input = document.getElementById("title");
                const history = getHistory();
        
                if (history.length === 0 || document.activeElement !== input) {
                    box.style.display = "none";
                    return;
                }
        
                box.style.display = "block";
                box.innerHTML = "";
        
                history.forEach(item => {
                    const div = document.createElement("div");
                    div.className = "history-item";
        
                    const span = document.createElement("span");
                    span.className = "history-title";
                    span.textContent = item;
                    span.onclick = () => {
                        input.value = item;
                        searchBook();
                        box.style.display = "none";
                    };
        
                    const btn = document.createElement("button");
                    btn.className = "delete-btn";
                    btn.textContent = "Ã—";
                    btn.onclick = (e) => {
                        e.stopPropagation();
                        deleteHistory(item);
                    };
        
                    div.appendChild(span);
                    div.appendChild(btn);
                    box.appendChild(div);
                });
            }
        
            // -----------------------------
            // ã€Œç§ã®æœ¬æ£šã€è¡¨ç¤º
            // -----------------------------
            function updateMyShelfDisplay() {
                const shelfDiv = document.getElementById("my-shelf-books");
                if (!shelfDiv) return;
                shelfDiv.innerHTML = "";
        
                myShelf.forEach(book => {
                    const bookDiv = document.createElement("div");
                    bookDiv.className = "book";
        
                    const star = document.createElement("span");
                    star.className = "star";
                    star.textContent = "â˜…";
                    star.style.cursor = "pointer";
                    star.onclick = () => {
                        const index = myShelf.findIndex(b => b.title === book.title);
                        if (index !== -1) myShelf.splice(index, 1);
                        saveShelfLocal();
                        updateMyShelfDisplay();
                        displaySearchResults();
                    };
        
                    const imgLink = document.createElement("a");
                    imgLink.href = book.itemUrl;
                    imgLink.target = "_blank";
        
                    const img = document.createElement("img");
                    img.src = book.image;
                    img.alt = book.title;
                    imgLink.appendChild(img);
        
                    bookDiv.appendChild(imgLink);
                    bookDiv.appendChild(star);
        
                    const details = document.createElement("div");
                    details.className = "book-details";
                    details.innerHTML = `
                        <p>ä¾¡æ ¼: Â¥${book.price}</p>
                        <p>è‘—è€…: ${book.author}</p>
                    `;
                    bookDiv.appendChild(details);
        
                    shelfDiv.appendChild(bookDiv);
                });
            }
        
            // -----------------------------
            // æœ¬æ¤œç´¢ã®çµæœã‚’çµ±ä¸€å½¢å¼ã«å¤‰æ›
            // -----------------------------
            function normalizeBook(rawBook) {
                return {
                    title: rawBook.title || "",
                    author: rawBook.author || "",
                    price: rawBook.price || "æƒ…å ±ãªã—",
                    image: rawBook.image || rawBook.cover || "",
                    itemUrl: rawBook.itemUrl || rawBook.url || "#",
                    isbn: rawBook.isbn || "",
                };
            }
        
            
// -----------------------------
// å›³æ›¸é¤¨æƒ…å ±å–å¾—ï¼ˆæ¤œç´¢çµæœä¸‹ã«æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã§ã¾ã¨ã‚ã¦è¡¨ç¤ºï¼‰
// -----------------------------
async function fetchNearbyLibraries(title) {
    const containerDiv = document.getElementById("library-results");
    if (!navigator.geolocation) {
        containerDiv.innerHTML = "<p>ä½ç½®æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã€‚</p>";
        return;
    }

    navigator.geolocation.getCurrentPosition(async (position) => {
        const userLat = position.coords.latitude;
        const userLon = position.coords.longitude;

        try {
            const res = await fetch(`/search?title=${encodeURIComponent(title)}&lat=${userLat}&lon=${userLon}`);
            const books = await res.json();
            if (!books || books.length === 0) {
                containerDiv.innerHTML = "<p>æœ¬ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚</p>";
                return;
            }

            // å›³æ›¸é¤¨ã‚’é‡è¤‡ã•ã›ãšã«ã¾ã¨ã‚ã‚‹
            const libMap = {};
            books.forEach(book => {
                if (book.libraries && book.libraries.length > 0) {
                    book.libraries.forEach(lib => {
                        if (!lib.name) return;
                        if (!libMap[lib.name]) {
                            if (lib.lat && lib.lon) {
                                lib.distance = getDistance(userLat, userLon, lib.lat, lib.lon);
                            } else {
                                lib.distance = Infinity;
                            }
                            libMap[lib.name] = lib;
                        }
                    });
                }
            });

            const libraries = Object.values(libMap);
            if (libraries.length === 0) {
                containerDiv.innerHTML = "<p>è¿‘ãã®å›³æ›¸é¤¨æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>";
                return;
            }

            // è·é›¢é †ã«ã‚½ãƒ¼ãƒˆ
            libraries.sort((a, b) => a.distance - b.distance);

            // æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç”¨ãƒ©ãƒƒãƒ‘ãƒ¼
            const wrapperDiv = document.createElement("div");
            wrapperDiv.className = "shelf-links"; // æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«è¦ª
            wrapperDiv.style.display = "flex";     // â†ã“ã‚Œã§æ¨ªä¸¦ã³
            wrapperDiv.style.overflowX = "auto";
            wrapperDiv.style.gap = "10px";         // ã‚¢ã‚¤ãƒ†ãƒ é–“éš”
            containerDiv.innerHTML = "";
            containerDiv.appendChild(wrapperDiv);

            libraries.forEach(lib => {
                const libDiv = document.createElement("div");
                libDiv.className = "shelf-link";
                libDiv.style.flex = "0 0 auto"; // â†ã“ã‚Œã§æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å†…ã§ç¸¦ã«ãªã‚‰ãªã„

                const mapUrl = (lib.lat && lib.lon)
                    ? `https://www.google.com/maps/search/?api=1&query=${lib.lat},${lib.lon}`
                    : "#";

                let displayName = lib.name;
                if (!displayName.includes("å›³æ›¸é¤¨")) {
                    displayName += "å›³æ›¸é¤¨";
                }

                libDiv.innerHTML = `
                    ğŸ“š <a href="${mapUrl}" target="_blank" class="library-item-link">${displayName}</a>
                    (${lib.distance !== Infinity ? lib.distance.toFixed(1) + " km" : "-"})
                `;
                wrapperDiv.appendChild(libDiv);
            });

        } catch (err) {
            console.error(err);
            containerDiv.innerHTML = "<p>å›³æ›¸é¤¨æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>";
        }

    }, (err) => {
        containerDiv.innerHTML = "<p>ä½ç½®æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>";
    });
}

// -----------------------------
// è·é›¢è¨ˆç®—é–¢æ•°ï¼ˆkmå˜ä½ï¼‰
// -----------------------------
function getDistance(lat1, lon1, lat2, lon2) {
    const R = 6371; // åœ°çƒåŠå¾„ km
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a =
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) *
        Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
}

// -----------------------------
// æ¤œç´¢çµæœè¡¨ç¤º
// -----------------------------
function displaySearchResults() {
    const resultsDiv = document.getElementById("search-results");
    if (!resultsDiv) return;
    resultsDiv.innerHTML = "";

    searchResults.forEach(rawBook => {
        const book = normalizeBook(rawBook);

        // æ–°ã—ã„æœ¬ãªã‚‰ window.allBooks ã«è¿½åŠ 
        if (!window.allBooks.find(b => b.title === book.title)) {
            window.allBooks.push(book);
        }

        const bookDiv = document.createElement("div");
        bookDiv.className = "book";
        bookDiv.style.display = "flex";
        bookDiv.style.flexDirection = "column";
        bookDiv.style.alignItems = "center";

        // â­ãƒãƒ¼ã‚¯
        const star = document.createElement("span");
        star.className = "star";
        star.textContent = myShelf.find(b => b.title === book.title) ? "â˜…" : "â˜†";
        star.style.cursor = "pointer";
        star.onclick = () => {
            const index = myShelf.findIndex(b => b.title === book.title);
            if (index === -1) myShelf.push(book);
            else myShelf.splice(index, 1);
            saveShelfLocal();
            updateMyShelfDisplay();
            displaySearchResults();
        };

        // ç”»åƒãƒªãƒ³ã‚¯
        const imgLink = document.createElement("a");
        imgLink.href = book.itemUrl;
        imgLink.target = "_blank";
        imgLink.onclick = () => addToViewHistory(book);

        const img = document.createElement("img");
        img.src = book.image;
        img.alt = book.title;
        imgLink.appendChild(img);

        bookDiv.appendChild(imgLink);
        bookDiv.appendChild(star);

        // æœ¬ã®è©³ç´°ï¼ˆåˆæœŸéè¡¨ç¤ºï¼‰
        const detailsDiv = document.createElement("div");
        detailsDiv.className = "book-details";
        detailsDiv.innerHTML = `<p>ä¾¡æ ¼: Â¥${book.price}</p><p>è‘—è€…: ${book.author}</p>`;
        bookDiv.appendChild(detailsDiv);

        // ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³
        const toggleBtn = document.createElement("span");
        toggleBtn.className = "toggle-btn";
        toggleBtn.textContent = "è©³ç´°è¡¨ç¤º";
        toggleBtn.onclick = () => {
            detailsDiv.classList.toggle("show");
        };
        bookDiv.appendChild(toggleBtn);

        resultsDiv.appendChild(bookDiv);
    });

    // é–²è¦§å±¥æ­´ã«åŸºã¥ããŠã™ã™ã‚ã‚’æ›´æ–°
    displayRecommendedBooksByKeywords();

    // æ¤œç´¢çµæœä¸‹ã«å›³æ›¸é¤¨æƒ…å ±ã‚’è¡¨ç¤º
    if (searchResults.length > 0) fetchNearbyLibraries(searchResults[0].title);
}

// -----------------------------
// ã‚ãªãŸã«ãŠã™ã™ã‚ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ã¨è‘—è€…ã§ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒãƒï¼‰
// -----------------------------
function displayViewHistory() {
    const historyDiv = document.getElementById("view-history");
    if (!historyDiv) return;
    historyDiv.innerHTML = "";

    const history = JSON.parse(localStorage.getItem("viewHistory") || "[]");
    if (history.length === 0) return;

    // æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç”¨ãƒ©ãƒƒãƒ‘ãƒ¼
    const wrapper = document.createElement("div");
    wrapper.style.display = "flex";
    wrapper.style.overflowX = "auto";
    wrapper.style.gap = "10px"; // æœ¬åŒå£«ã®é–“éš”

    history.forEach(book => {
        const bookDiv = document.createElement("div");
        bookDiv.className = "book";
        bookDiv.style.flex = "0 0 auto"; // æ¨ªä¸¦ã³ã§ç¸¦ã«åºƒãŒã‚‰ãªã„
        bookDiv.style.display = "flex";
        bookDiv.style.flexDirection = "column";
        bookDiv.style.alignItems = "center";

        const imgLink = document.createElement("a");
        imgLink.href = book.itemUrl;
        imgLink.target = "_blank";

        const img = document.createElement("img");
        img.src = book.image;
        img.alt = book.title;
        imgLink.appendChild(img);
        bookDiv.appendChild(imgLink);

        const detailsDiv = document.createElement("div");
        detailsDiv.className = "book-details";
        detailsDiv.innerHTML = `<p>ä¾¡æ ¼: Â¥${book.price}</p><p>è‘—è€…: ${book.author}</p>`;
        bookDiv.appendChild(detailsDiv);

        wrapper.appendChild(bookDiv);
    });

    historyDiv.appendChild(wrapper);
}

// -----------------------------
// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚
// -----------------------------
window.addEventListener("DOMContentLoaded", () => {
    displayViewHistory();
    displayRecommendedBooksByKeywords();
});

            // -----------------------------
            // é–²è¦§å±¥æ­´æ©Ÿèƒ½
            // -----------------------------
            function addToViewHistory(book) {
                let history = JSON.parse(localStorage.getItem("viewHistory") || "[]");
        
                if (!history.find(b => b.title === book.title)) {
                    history.unshift(book);
                    if (history.length > 20) history.pop();
                }
        
                localStorage.setItem("viewHistory", JSON.stringify(history));
                displayViewHistory();
            }
        
            function displayViewHistory() {
                const historyDiv = document.getElementById("view-history");
                if (!historyDiv) return;
                historyDiv.innerHTML = "";
        
                const history = JSON.parse(localStorage.getItem("viewHistory") || "[]");
        
                history.forEach(book => {
                    const bookDiv = document.createElement("div");
                    bookDiv.className = "book";
        
                    const imgLink = document.createElement("a");
                    imgLink.href = book.itemUrl;
                    imgLink.target = "_blank";
        
                    const img = document.createElement("img");
                    img.src = book.image;
                    img.alt = book.title;
        
                    imgLink.appendChild(img);
                    bookDiv.appendChild(imgLink);
        
                    const detailsDiv = document.createElement("div");
                    detailsDiv.className = "book-details";
                    detailsDiv.innerHTML = `<p>ä¾¡æ ¼: Â¥${book.price}</p><p>è‘—è€…: ${book.author}</p>`;
                    bookDiv.appendChild(detailsDiv);
        
                    historyDiv.appendChild(bookDiv);
                });
            }
        
            // -----------------------------
            // æœ¬ã‚’æ¤œç´¢
            // -----------------------------
            async function searchBook() {
                const titleInput = document.getElementById("title");
                const title = titleInput.value.trim();
                if (!title) return;
        
                const res = await fetch(`/search?title=${encodeURIComponent(title)}`);
                const books = await res.json();
                searchResults = books;
        
                addHistory(title);
                localStorage.setItem("lastSearch", JSON.stringify({ title, books }));
                displaySearchResults();
            }


            // -----------------------------
            // åˆæœŸãƒ­ãƒ¼ãƒ‰
            // -----------------------------
            window.onload = () => {
                myShelf = loadShelfLocal();
                updateMyShelfDisplay();
        
                const input = document.getElementById("title");
                const historyBox = document.getElementById("search-history-box");
        
                const lastSearch = localStorage.getItem("lastSearch");
                if (lastSearch) {
                    const data = JSON.parse(lastSearch);
                    input.value = data.title;
                    searchResults = data.books;
                    displaySearchResults();
                }
        
                input.addEventListener("keydown", (e) => {
                    if (e.key === "Enter") searchBook();
                });
        
                input.addEventListener("focus", () => displayHistory());
                input.addEventListener("input", () => displayHistory());
        
                historyBox.addEventListener("mousedown", (e) => e.preventDefault());
        
                document.addEventListener("click", (e) => {
                    if (!input.contains(e.target) && !historyBox.contains(e.target)) {
                        historyBox.style.display = "none";
                    }
                });
        
                displayViewHistory();
            };
        </script>
        <script>
            window.allBooks = [{
      "author": "æ¸…åŸ é”éƒ",
      "description": "â– è©±é¡Œæ²¸é¨°ã€€é€£ç¶šé‡ç‰ˆãŸã¡ã¾ã¡24ä¸‡éƒ¨çªç ´ï¼\nå€‹äººè³‡ç”£800å„„å††è¶…ã€‚é•·è€…ç•ªä»˜1ä½ã¨ãªã£ãŸä¼èª¬ã®ã‚µãƒ©ãƒªãƒ¼ãƒãƒ³æŠ•è³‡å®¶ãƒ»æ¸…åŸé”éƒã€‚\nå’½é ­ãŒã‚“ã§å£°å¸¯ã‚’å¤±ã„ã€å¼•é€€ã‚’æ±ºã‚ãŸã„ã¾ã€å…¨äººç”Ÿã§å¾—ãŸæ ªå¼æŠ•è³‡ã®ãƒã‚¦ãƒã‚¦ã‚’æ˜ã‹ã™\nâ– æ–°NISAå®Œå…¨å¯¾å¿œï¼ã€€ã™ã¹ã¦ã®æŠ•è³‡å®¶ã®ãƒã‚¤ãƒ–ãƒ«èª•ç”Ÿ\nç§ã«ã¯å¾Œç¶™è€…ãŒã„ãªã„ã€‚ãªã‚‰ã°ã™ã¹ã¦ã®ãƒã‚¦ãƒã‚¦ã‚’å…¨éƒ¨ä¸–ã®ä¸­ã«ã€Œã¶ã¡ã¾ã‘ã¦ã—ã¾ãˆã€ã¨ã„ã†æ°—æŒã¡ã«ãªã£ãŸã€‚ä»Šã‚„æ ªå¼å¸‚å ´ã¯ã€Œå€‹äººãŒè‡ªç”±ã«å„²ã‘ã‚‹ã“ã¨ãŒã§ãã‚‹å¸‚å ´ã€ã§ã™ã€‚2024å¹´ã‹ã‚‰ã¯æ–°NISAã‚‚å§‹ã¾ã‚Šã¾ã—ãŸã€‚ã€Œã‚„ã‚‰ãªãã‚ƒçµ¶å¯¾æã€ã¨ã„ã†å€‹äººã«ã¨ã£ã¦ã¯å¤¢ã®ã‚ˆã†ãªåˆ¶åº¦ã§ã™ã€‚ï¼ˆæœ¬æ›¸ã‚ˆã‚Šï¼‰\nâ– æ ªå¼æŠ•è³‡ã«æ‰èƒ½ãªã©å­˜åœ¨ã—ãªã„ã€‚ã€Œè‡ªåˆ†ã®å¤±æ•—ã‹ã‚‰ã©ã‚Œã ã‘å­¦ã‚“ã ã‹ã€ã ã‘ã ã€‚\n\nã€Šç›®æ¬¡ã€‹\nâ– ç¬¬1ç« ã€€å¸‚å ´ã¯ã‚ãªãŸã‚’è¦‹æ¨ã¦ãªã„\nã€€é–“é•ã£ã¦ã‚‚æã‚’ã™ã‚‹ã¨ã¯é™ã‚‰ãªã„ã€€æ­£ã—ã‹ã£ãŸã‚‰å„²ã‹ã‚‹ã¨ã¯é™ã‚‰ãªã„ï¼æŠ•è³‡ã®ã‚¢ã‚¤ãƒ‡ã‚¢=æ ªä¾¡ã«ç¹”ã‚Šè¾¼ã¾ã‚Œã¦ã„ãªã„ã‚¢ã‚¤ãƒ‡ã‚¢ï¼ã™ã¹ã¦ã®æƒ…å ±ã«ã¯ãƒã‚¤ã‚¢ã‚¹ãŒã‹ã‹ã£ã¦ã„ã‚‹ï¼æƒ…å ±åé›†ã«é‡‘ã‚’ã‹ã‘ã‚‹å¿…è¦ã¯ãªã—ï¼æŠ•è³‡å®¶ã¯ç›¸å ´ã«å‹ã¦ã‚‹ã®ã‹ï¼ãƒ‘ãƒƒã‚·ãƒ–é‹ç”¨vs.ã‚¢ã‚¯ãƒ†ã‚£ãƒ–é‹ç”¨ã€€ã»ã‹\nâ– ç¬¬2ç« ã€€ãƒ˜ãƒƒã‚¸ãƒ•ã‚¡ãƒ³ãƒ‰ã¸ã®é•·ã„é“ã®ã‚Š\nã€€é‡æ‘è­‰åˆ¸å…¥ç¤¾â”€â”€æŠ±ã„ãŸã€Œå¼·çƒˆãªé•å’Œæ„Ÿã€ï¼æã‚’ã™ã‚‹å€‹äººæŠ•è³‡å®¶ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼åŒ—å°¾å‰å­æ°ã«æ•‘ã‚ã‚Œã‚‹ï¼è»æ›¹ï¼ã€Œè…ã‚Œç‰ã€ã®è¡Œæ–¹ï¼ã€Œãƒ­ãƒ³ã‚°ãƒ»ã‚·ãƒ§ãƒ¼ãƒˆé‹ç”¨ã€ã®å¤œæ˜ã‘ã€€ã»ã‹\nâ– ç¬¬3ç« ã€€ã€Œå‰²å®‰å°å‹æˆé•·æ ªã€ã®ç ´å£ŠåŠ›\nã€€å®Ÿã¯å½¹ã«ç«‹ãŸãªã„ã€ŒPBRã€ï¼ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‹ãƒ¥ãƒ¼ãƒˆãƒ©ãƒ«PERã®å•é¡Œç‚¹ï¼ã€Œ1æ®µéšãƒ¢ãƒ‡ãƒ«ã€ã¯ä½PERæ ªã«æœ‰åŠ¹ï¼é‡‘åˆ©ãŒä¸ŠãŒã‚‹ã¨ã€é«˜PERæ ªã¯ä¸åˆ©ï¼Ÿï¼ã€Œã‚¤ãƒ¡ãƒ¼ã‚¸ã®æ‚ªã„æ¥­ç•Œã€ã“ããƒãƒ£ãƒ³ã‚¹ï¼ãƒãƒªãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã®æ¢¯å­ã‚’ä¸Šã‚‹ï¼è³‡é‡‘100ä¸‡å††ã§ã€Œå‰²å®‰å°å‹æˆé•·æ ªã€æŠ•è³‡ï¼ã€Œæˆé•·æ ªæŠ•è³‡ã€ã¨ã€Œãƒãƒªãƒ¥ãƒ¼æŠ•è³‡ã€ã®é•ã„ï¼ãƒã‚¶ãƒ¼ã‚ºï¼ˆã‚°ãƒ­ãƒ¼ã‚¹ï¼‰ã¯ã€Œæœ€æ‚ªã®å¸‚å ´ã€ï¼ã€Œãƒˆãƒ¬ãƒ³ãƒ‰ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ã€ã¨ã€Œã‚³ãƒ³ãƒˆãƒ©ãƒªã‚¢ãƒ³ã€ã€€ã»ã‹\nâ– ç¬¬4ç« ã€€åœ°ç„ã®æ²™æ±°ã¯æŒæ ªæ¬¡ç¬¬â”€25å¹´é–“ã®è»Œè·¡\nã€€K1ãƒ•ã‚¡ãƒ³ãƒ‰ã®é‹ç”¨ã‚¹ã‚¿ã‚¤ãƒ«ã®å¤‰é·ï¼ãƒ•ã‚¡ãƒ³ãƒ‰ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã€€ã»ã‹\nâ– ç¬¬5ç« ã€€REITâ”€è½ã¡ã¦ãã‚‹ãƒŠã‚¤ãƒ•ã‚’2åº¦ã¤ã‹ã‚€\nã€€ã¾ã•ã‹ã®IPOã€Œ20å„„å††åˆ†ã€å½“é¸ï¼ãƒªãƒ¼ãƒãƒ³ã‚·ãƒ§ãƒƒã‚¯ã¨REITæš´è½\nâ– ç¬¬6ç« ã€€å®Ÿè·µã®ãƒã‚¤ãƒ©ã‚¤ãƒˆâ”€ãƒ­ãƒ³ã‚°\nâ– ç¬¬7ç« ã€€å®Ÿè·µã®ãƒã‚¤ãƒ©ã‚¤ãƒˆâ”€ã‚·ãƒ§ãƒ¼ãƒˆãƒ»ãƒšã‚¢ãƒ¼ãƒˆãƒ¬ãƒ¼ãƒ‰\nã€€å€‹äººæŠ•è³‡å®¶ã«ã¯å€‹åˆ¥éŠ˜æŸ„ã®ã‚·ãƒ§ãƒ¼ãƒˆã¯å‹§ã‚ã‚‰ã‚Œãªã„ï¼ã‚·ãƒ§ãƒ¼ãƒˆã®åˆ†æ•£æŠ•è³‡ã¯ãŠã‚ã‹ãªè¡Œç‚ºï¼æ—¥çµŒ225æŒ‡æ•°ã®é—‡ï¼ã‚ˆã†ã‚„ãã‚ã‹ã£ãŸã‚·ãƒ§ãƒ¼ãƒˆã®å‹ã¡æ–¹ã€€ã»ã‹\nâ– ç¬¬8ç« ã€€ã‚„ã£ã¦ã¯ã„ã‘ãªã„æŠ•è³‡\nã€€ESGæŠ•è³‡ã¯ãƒŠãƒ³ã‚»ãƒ³ã‚¹ï¼æœªå…¬é–‹æ ªã¯æ±ºã—ã¦è²·ã£ã¦ã¯ã„ã‘ãªã„ã€€ã»ã‹\nâ– ç¬¬9ç« ã“ã‚Œã‹ã‚‰ã®æ—¥æœ¬æ ªå¸‚å ´\nã€€10å¹´ä»¥å†…ã«èµ·ãã‚‹ç ´æ»…çš„ãƒªã‚¹ã‚¯ï¼ä»Šå¾Œã®æ—¥æœ¬æ ªã‚’å–ã‚Šå·»ãç’°å¢ƒã€Œ8ã€ã®äºˆæƒ³ï¼ç¸®å°ã‚’ç¶šã‘ã‚‹å†…éœ€ï¼æ—¥æœ¬æ ªã‚·ãƒ§ãƒ¼ãƒ†ãƒƒã‚¸æ™‚ä»£ã®åˆ°æ¥ã€€ã»ã‹\nç¬¬1ç« ã€€å¸‚å ´ã¯ã‚ãªãŸã‚’è¦‹æ¨ã¦ãªã„\nç¬¬2ç« ã€€ãƒ˜ãƒƒã‚¸ãƒ•ã‚¡ãƒ³ãƒ‰ã¸ã®é•·ã„é“ã®ã‚Š\nç¬¬3ç« ã€€ã€Œå‰²å®‰å°å‹æˆé•·æ ªã€ã®ç ´å£ŠåŠ›\nç¬¬4ç« ã€€åœ°ç„ã®æ²™æ±°ã¯æŒæ ªæ¬¡ç¬¬â”€â”€25å¹´é–“ã®è»Œè·¡\nç¬¬5ç« ã€€REITâ”€â”€è½ã¡ã¦ãã‚‹ãƒŠã‚¤ãƒ•ã‚’2åº¦ã¤ã‹ã‚€\nç¬¬6ç« ã€€å®Ÿè·µã®ãƒã‚¤ãƒ©ã‚¤ãƒˆâ”€â”€ãƒ­ãƒ³ã‚°\nç¬¬7ç« ã€€å®Ÿè·µã®ãƒã‚¤ãƒ©ã‚¤ãƒˆâ”€â”€ã‚·ãƒ§ãƒ¼ãƒˆãƒ»ãƒšã‚¢ãƒ¼ãƒˆãƒ¬ãƒ¼ãƒ‰\nç¬¬8ç« ã€€ã‚„ã£ã¦ã¯ã„ã‘ãªã„æŠ•è³‡\nç¬¬9ç« ã€€ã“ã‚Œã‹ã‚‰ã®æ—¥æœ¬æ ªå¸‚å ´",
      "image": "https://thumbnail.image.rakuten.co.jp/@0_mall/book/cabinet/0355/9784065350355_1_2.jpg?_ex=200x200",
      "itemUrl": "https://books.rakuten.co.jp/rb/17770405/?rafcid=wsc_b_bs_1077795699367532233",
      "price": 1980,
      "title": "ã‚ãŒæŠ•è³‡è¡“ã€€å¸‚å ´ã¯èª°ã«å¾®ç¬‘ã‚€ã‹"
    },
    {
      "author": "ãƒ™ãƒ³ã‚¸ãƒ£ãƒŸãƒ³ãƒ»ã‚°ãƒ¬ã‚¢ãƒ ",
      "description": "ã€è³¢æ˜ãªã‚‹æŠ•è³‡å®¶ã€ã®ç†è§£åº¦ãŒä¸€æ°—ã«é€²ã‚€ç§€é€¸ãªã€Œè§£èª¬ã€ä»˜ãï¼æŠ•è³‡æœ¬ãªã‹ã§æœ€é«˜å‚‘ä½œã¨ã ã‚Œã‚‚ãŒèªã‚ã‚‹ãƒ™ãƒ³ã‚¸ãƒ£ãƒŸãƒ³ãƒ»ã‚°ãƒ¬ã‚¢ãƒ ã®ã€è³¢æ˜ãªã‚‹æŠ•è³‡å®¶ã€ã‚’ã€ã‚¦ã‚©ãƒ¼ãƒ«ãƒ»ã‚¹ãƒˆãƒªãƒ¼ãƒˆãƒ»ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ã®å‚‘å‡ºã—ãŸé‡‘èã‚¸ãƒ£ãƒ¼ãƒŠãƒªã‚¹ãƒˆã§ã‚ã‚‹ã‚¸ã‚§ã‚¤ã‚½ãƒ³ãƒ»ãƒ„ãƒã‚¤ã‚¯ãŒå„ç« ã”ã¨ã«ç¾ä»£ã®å¸‚å ´ã«åˆã‚ã›ã¦è§£èª¬ã‚’åŠ ãˆãŸã®ãŒæœ¬æ›¸ã§ã‚ã‚‹ã€‚æœ¬æ›¸ã‚’èª­ã‚ã°ã€ã‚°ãƒ¬ã‚¢ãƒ ãŒä¸»å¼µã—ç¶šã‘ã¦ããŸã€Œãƒãƒªãƒ¥ãƒ¼æŠ•è³‡ã€ã®å¥¥ç¾©ã§ã‚ã‚‹ã€Œå®‰å…¨æ€§åˆ†æï¼ˆï½“ï½…ï½ƒï½•ï½’ï½‰ï½”ï½™ã€€ï½ï½ï½ï½Œï½™ï½“ï½‰ï½“ï¼‰ã€ã¨ã„ã†æ™®éçš„åŸå‰‡ã‚’æŠ•è³‡ã«ã„ã‹ã«é©ç”¨ã—ã€å®Ÿè·µã™ã‚‹ã‹ãŒæ‰‹ã«å–ã‚‹ã‚ˆã†ã«åˆ†ã‹ã‚‹ã€‚",
      "image": "https://thumbnail.image.rakuten.co.jp/@0_mall/book/cabinet/3400/9784775973400_1_2.jpg?_ex=200x200",
      "itemUrl": "https://books.rakuten.co.jp/rb/18327208/?rafcid=wsc_b_bs_1077795699367532233",
      "price": 4180,
      "title": "æ–°ã€€è³¢æ˜ãªã‚‹æŠ•è³‡å®¶ï¼ˆä¸‹ï¼‰ç¬¬3ç‰ˆ"
    },
    {
      "author": "ãƒ™ãƒ³ã‚¸ãƒ£ãƒŸãƒ³ãƒ»ã‚°ãƒ¬ã‚¢ãƒ /ã‚¸ã‚§ã‚¤ã‚½ãƒ³ãƒ»ãƒ„ãƒã‚¤ã‚¯",
      "description": "æœ¬æ›¸ã¯ã€æŠ•è³‡ã«é–¢ã™ã‚‹æ°¸ä¹…ä¸æ»…ã®å¤å…¸ã§ã‚ã‚Šã€å®‰å…¨æ€§åˆ†æï¼ˆï½“ï½…ï½ƒï½•ï½’ï½‰ï½”ï½™ã€€ï½ï½ï½ï½Œï½™ï½“ï½‰ï½“ï¼‰ã®æ™®éçš„åŸå‰‡ãŒè©°ã‚è¾¼ã¾ã‚Œã¦ã„ã‚‹ãƒ™ãƒ³ã‚¸ãƒ£ãƒŸãƒ³ãƒ»ã‚°ãƒ¬ã‚¢ãƒ ã®ã€è³¢æ˜ãªã‚‹æŠ•è³‡å®¶ã€ã‚’å…ƒã«ï¼ˆã€è³¢æ˜ãªã‚‹æŠ•è³‡å®¶ã€ã«ã¯ä¸€åˆ‡æ‰‹ã‚’åŠ ãˆã¦ã„ãªã„ï¼‰ã€ã‚¦ã‚©ãƒ¼ãƒ«ãƒ»ã‚¹ãƒˆãƒªãƒ¼ãƒˆãƒ»ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ã®è‘—åãªæŠ•è³‡ãƒ©ã‚¤ã‚¿ãƒ¼ã§ã‚ã‚‹ã‚¸ã‚§ã‚¤ã‚½ãƒ³ãƒ»ãƒ„ãƒã‚¤ã‚¯ãŒå„ç« ã”ã¨ã«ã€ç¾ä»£ã®çŠ¶æ³ã«ãƒãƒƒãƒã™ã‚‹å½¢ã§æœ€æ–°ã®è§£èª¬ã‚’æ›¸ãä¸‹ã‚ã—ãŸã‚‚ã®ã§ã‚ã‚‹ã€‚ã¾ãŸã€ä¼èª¬ã®æŠ•è³‡å®¶ã§ã€è‘—è€…ã®æœ€ã‚‚æœ‰åã§å¤§æˆåŠŸã—ãŸå¼Ÿå­ã§ã‚ã‚‹ã‚¦ã‚©ãƒ¼ãƒ¬ãƒ³ãƒ»ãƒãƒ•ã‚§ãƒƒãƒˆã‚‚åºæ–‡ã¨ä»˜éŒ²ã‚’å¯„ç¨¿ã—ã¦ã„ã‚‹ã€‚",
      "image": "https://thumbnail.image.rakuten.co.jp/@0_mall/book/cabinet/3394/9784775973394_1_2.jpg?_ex=200x200",
      "itemUrl": "https://books.rakuten.co.jp/rb/18304478/?rafcid=wsc_b_bs_1077795699367532233",
      "price": 4180,
      "title": "æ–°ã€€è³¢æ˜ãªã‚‹æŠ•è³‡å®¶ï¼ˆä¸Šï¼‰ç¬¬3ç‰ˆ"
    },
    {
      "author": "ãƒ™ãƒ³ã‚¸ãƒ£ãƒŸãƒ³ãƒ»ã‚°ãƒ¬ã‚¢ãƒ /å¢—æ²¢å’Œç¾",
      "description": "å¾…æœ›ï¼ã€€æ—¥æœ¬åˆã®ã€Œæ”¹è¨‚ç¬¬4ç‰ˆã€ã‚’å®Œå…¨ç¿»è¨³\nãƒãƒ•ã‚§ãƒƒãƒˆãŒå¸«ã¨ä»°ãã€å°Šæ•¬ã—ãŸãƒ™ãƒ³ã‚¸ãƒ£ãƒŸãƒ³ãƒ»ã‚°ãƒ¬ã‚¢ãƒ ãŒæ®‹ã—ãŸã€Œãƒãƒªãƒ¥ãƒ¼æŠ•è³‡ã€ã®æœ€é«˜å‚‘ä½œï¼æ ªå¼ã¨å‚µåˆ¸ã®é…åˆ†æ–¹æ³•ã€ã ã‚Œã‚‚æ°—ã¥ã„ã¦ã„ãªã„å°†æ¥ä¼¸ã³ã‚‹ã€Œé­…åŠ›ã®ãªã„äºŒæµä¼æ¥­æ ªã€ã‚„ã€Œå‰²å®‰æ ªã€ã®è¦‹ã¤ã‘æ–¹ã‚’ä¼æˆï¼ å ´ä¸­ã‚„ã€æ˜æ—¥ã€1ã‚«æœˆå¾Œã®å€¤å‹•ãã‚’å…¨ãæ°—ã«ã—ãªã„ã€ŒæŠ•è³‡æ³•ã€ãƒ»ãƒ»ãƒ»åŸæ›¸ã¯ã€ä»Šã§ã‚‚ã‚¢ãƒ¡ãƒªã‚«ã§ãƒ­ãƒ³ã‚°ã‚»ãƒ©ãƒ¼ã§ã‚ã‚Šç¶šã‘ã¦ã„ã‚‹å¤å…¸çš„åè‘—ã€‚æ•°åå¹´å‰ã‹ã‚‰æ™‚ä»£é…ã‚Œãªæœ¬ã¨ã„ã‚ã‚Œç¶šã‘ãªãŒã‚‰ã‚‚ã€ã‚„ã¯ã‚ŠçœŸç†ã¨ã¯æ™®éçš„ãªã‚‚ã®ã§ã‚ã‚Šã€äººã€…ã«å¿…è¦ã¨ã•ã‚Œã¦ããŸæ›¸ç‰©ã§ã‚ã‚‹ã€‚ITãƒãƒ–ãƒ«ãŒã¯ã˜ã‘ãŸä»Šã€ãƒãƒªãƒ¥ãƒ¼æŠ•è³‡ã‚’å‹‰å¼·ã—ãŸã„ã¨é¡˜ã†æ–¹ã«ã¯ã€ãƒãƒ•ã‚§ãƒƒãƒˆã®æœ¬ã¨ã¨ã‚‚ã«ã€ãŠå‹§ã‚ã—ãŸã„ã€ŒæŠ•è³‡å®¶ã®æ•™ç§‘æ›¸ã€ã§ã‚ã‚‹ã€‚",
      "image": "https://thumbnail.image.rakuten.co.jp/@0_mall/book/cabinet/9391/93910329.jpg?_ex=200x200",
      "itemUrl": "https://books.rakuten.co.jp/rb/1320854/?rafcid=wsc_b_bs_1077795699367532233",
      "price": 4180,
      "title": "è³¢æ˜ãªã‚‹æŠ•è³‡å®¶"
    }
  ];
            
            // é–²è¦§å±¥æ­´ã«è¿½åŠ 
            function addToViewHistory(book) {
                let history = JSON.parse(localStorage.getItem("viewHistory") || "[]");
                if (!history.find(b => b.title === book.title)) {
                    history.unshift(book);
                    if (history.length > 20) history.pop();
                }
                localStorage.setItem("viewHistory", JSON.stringify(history));
                displayViewHistory();
                displayRecommendedBooksByKeywords();
            }
            
            // é–²è¦§å±¥æ­´è¡¨ç¤ºï¼ˆæ—¢å­˜ã®displayViewHistoryã¨åŒã˜ï¼‰
            function displayViewHistory() {
                const historyDiv = document.getElementById("view-history");
                if (!historyDiv) return;
                historyDiv.innerHTML = "";
                const history = JSON.parse(localStorage.getItem("viewHistory") || "[]");
                history.forEach(book => {
                    const bookDiv = document.createElement("div");
                    bookDiv.className = "book";
                    const imgLink = document.createElement("a");
                    imgLink.href = book.itemUrl;
                    imgLink.target = "_blank";
                    const img = document.createElement("img");
                    img.src = book.image;
                    img.alt = book.title;
                    imgLink.appendChild(img);
                    bookDiv.appendChild(imgLink);
                    const detailsDiv = document.createElement("div");
                    detailsDiv.className = "book-details";
                    detailsDiv.innerHTML = `<p>ä¾¡æ ¼: Â¥${book.price}</p><p>è‘—è€…: ${book.author}</p>`;
                    bookDiv.appendChild(detailsDiv);
                    historyDiv.appendChild(bookDiv);
                });
            }
            
            // ã‚ãªãŸã«ãŠã™ã™ã‚è¡¨ç¤º
            function displayRecommendedBooksByKeywords() {
    const recDiv = document.getElementById("recommend-books");
    if (!recDiv) return;
    recDiv.innerHTML = "";

    const history = JSON.parse(localStorage.getItem("viewHistory") || "[]");
    if (history.length === 0) return;

    const recBooks = [];
    const allBooks = window.allBooks || [];

    history.forEach(h => {
        const hWords = (h.title + " " + h.author).toLowerCase().split(/\s+/);
        allBooks.forEach(b => {
            if (!history.find(x => x.title === b.title) && !recBooks.find(x => x.title === b.title)) {
                const bWords = (b.title + " " + b.author).toLowerCase().split(/\s+/);
                if (hWords.some(hw => bWords.some(bw => bw.includes(hw) || hw.includes(bw)))) {
                    recBooks.push(b);
                }
            }
        });
    });

    if (recBooks.length === 0) return;

    // æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç”¨ wrapper
    const wrapperDiv = document.createElement("div");
    wrapperDiv.style.display = "flex";
    wrapperDiv.style.overflowX = "auto";
    wrapperDiv.style.gap = "10px";
    wrapperDiv.style.padding = "5px 0";

    recBooks.slice(0, 10).forEach(book => {
        const bookDiv = document.createElement("div");
        bookDiv.className = "book";
        bookDiv.style.flex = "0 0 auto"; // æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã§ç¸¦ã«ãªã‚‰ãªã„
        bookDiv.style.width = "130px";   // å¥½ããªå¹…ã«èª¿æ•´

        const imgLink = document.createElement("a");
        imgLink.href = book.itemUrl;
        imgLink.target = "_blank";

        const img = document.createElement("img");
        img.src = book.image;
        img.alt = book.title;
        img.style.width = "100%";
        imgLink.appendChild(img);
        bookDiv.appendChild(imgLink);

        const detailsDiv = document.createElement("div");
        detailsDiv.className = "book-details";
        detailsDiv.innerHTML = `<p>ä¾¡æ ¼: Â¥${book.price}</p><p>è‘—è€…: ${book.author}</p>`;
        bookDiv.appendChild(detailsDiv);

        wrapperDiv.appendChild(bookDiv);
    });

    recDiv.appendChild(wrapperDiv);
}

            
            // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«è¡¨ç¤º
            window.addEventListener("DOMContentLoaded", () => {
                displayViewHistory();
                displayRecommendedBooksByKeywords();
            });
            </script>
            
</body>
</html>