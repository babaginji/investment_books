<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>{{ shelf_name }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        /* タブ用簡易スタイル */
        .tabs { display: flex; gap: 10px; margin-bottom: 10px; }
        .tab { padding: 6px 12px; cursor: pointer; border: 1px solid #ccc; border-radius: 4px; background: #f9f9f9; }
        .tab.active { background: #0077cc; color: #fff; }
    </style>
</head>
<body>
    <h1>{{ shelf_name }}</h1>

    <!-- タブ切替 -->
    <div class="tabs-container">
        <div class="tabs">
            <div class="tab active" id="tab-all">すべて</div>
            <div class="tab" id="tab-read">既読</div>
        </div>
    </div>
    

    <!-- 本棚表示領域 -->
    <div id="books-container" class="books-container"></div>

    <p><a href="{{ url_for('index') }}">トップに戻る</a></p>

    <script>
        const shelfName = "{{ shelf_name }}";
        const shelfBooksFromServer = {{ books|tojson }};
        let myShelf = [];

        // -----------------------------
        // localStorage から「私の本棚」を取得
        // -----------------------------
        function loadMyShelf() {
            const data = JSON.parse(localStorage.getItem("myShelf") || "[]");
            return data.map(book => {
                if (typeof book.read === 'undefined') book.read = false;
                return book;
            });
        }
        function saveMyShelf() {
            localStorage.setItem("myShelf", JSON.stringify(myShelf));
        }

        // -----------------------------
        // 本ボックス作成
        // -----------------------------
        function createBookDiv(book) {
            const bookDiv = document.createElement('div');
            bookDiv.className = 'book';

            const star = document.createElement('span');
            star.className = 'star';
            star.textContent = '★';
            star.style.cursor = 'pointer';
            star.onclick = () => {
                myShelf = myShelf.filter(b => b.title !== book.title);
                saveMyShelf();
                displayShelf();
            };
            bookDiv.appendChild(star);

            const imgLink = document.createElement('a');
            imgLink.href = book.itemUrl;
            imgLink.target = '_blank';
            const img = document.createElement('img');
            img.src = book.image;
            img.alt = book.title;
            imgLink.appendChild(img);
            bookDiv.appendChild(imgLink);

            const titleH3 = document.createElement('h3');
            titleH3.textContent = book.title;
            bookDiv.appendChild(titleH3);

            const authorP = document.createElement('p');
            authorP.textContent = '著者: ' + book.author;
            bookDiv.appendChild(authorP);

            const priceP = document.createElement('p');
            priceP.textContent = '価格: ¥' + book.price;
            bookDiv.appendChild(priceP);

            const readBtn = document.createElement('button');
            readBtn.textContent = book.read ? '未読に戻す' : '既読にする';
            readBtn.style.fontSize = '12px';
            readBtn.style.padding = '2px 4px';
            readBtn.style.marginTop = '4px';
            readBtn.onclick = () => {
                book.read = !book.read;
                saveMyShelf();
                displayShelf();
            };
            bookDiv.appendChild(readBtn);

            return bookDiv;
        }
        // 本カードに右下のメモアイコン追加
        const memoBtn = document.createElement('span');
        memoBtn.textContent = '✏';
        memoBtn.style.position = 'absolute';
        memoBtn.style.bottom = '5px';
        memoBtn.style.right = '5px';
        memoBtn.style.fontSize = '16px';
        memoBtn.style.cursor = 'pointer';
        bookDiv.appendChild(memoBtn);

        // メモモーダル作成
        const memoModal = document.createElement('div');
        memoModal.style.position = 'fixed';
        memoModal.style.top = '50%';
        memoModal.style.left = '50%';
        memoModal.style.transform = 'translate(-50%, -50%)';
        memoModal.style.background = '#fff';
        memoModal.style.border = '1px solid #ccc';
        memoModal.style.padding = '15px';
        memoModal.style.zIndex = 10000;
        memoModal.style.display = 'none';
        memoModal.style.width = '80%';
        memoModal.style.maxWidth = '400px';
        memoModal.style.boxShadow = '0 4px 10px rgba(0,0,0,0.3)';
        memoModal.style.borderRadius = '8px';

        // ページ入力
        const pageInput = document.createElement('input');
        pageInput.type = 'text';
        pageInput.placeholder = 'ページ数';
        pageInput.style.width = '100%';
        pageInput.style.marginBottom = '10px';
        memoModal.appendChild(pageInput);

        // メモ本文
        const memoTextarea = document.createElement('textarea');
        memoTextarea.placeholder = 'メモを書く';
        memoTextarea.style.width = '100%';
        memoTextarea.style.height = '100px';
        memoModal.appendChild(memoTextarea);

        // 保存ボタン
        const saveMemoBtn = document.createElement('button');
        saveMemoBtn.textContent = '保存';
        saveMemoBtn.style.marginTop = '10px';
        saveMemoBtn.onclick = () => {
            book.page = pageInput.value;    // ページ数を本データに保存
            book.memo = memoTextarea.value; // メモ本文を保存
            updatePageBadge(bookDiv, book.page);
            memoModal.style.display = 'none';
            saveShelfLocal();
        };
        memoModal.appendChild(saveMemoBtn);

        // キャンセルボタン
        const cancelMemoBtn = document.createElement('button');
        cancelMemoBtn.textContent = 'キャンセル';
        cancelMemoBtn.style.marginLeft = '10px';
        cancelMemoBtn.onclick = () => {
            memoModal.style.display = 'none';
        };
        memoModal.appendChild(cancelMemoBtn);

        document.body.appendChild(memoModal);

        // メモボタン押したらモーダル表示
        memoBtn.onclick = () => {
            pageInput.value = book.page || '';
            memoTextarea.value = book.      memo || '';
            memoModal.style.display = 'block';
        };

        // 本カード右上のページ帯表示関数
        function updatePageBadge(bookDiv, page) {
            let badge = bookDiv.querySelector('.page-badge');
            if (!badge) {
                badge = document.createElement('div');
                badge.className = 'page-badge';
                bookDiv.appendChild(badge);
            }
            badge.textContent = page || '';
        }
        updatePageBadge(bookDiv, book.page);

        // -----------------------------
        // 本棚描画（表示モード: "all" or "read"）
        // -----------------------------
        let currentTab = "all";
        function displayShelf() {
            const container = document.getElementById('books-container');
            container.innerHTML = '';

            myShelf.forEach(book => {
                if (currentTab === "all" || (currentTab === "read" && book.read)) {
                    container.appendChild(createBookDiv(book));
                }
            });
        }

        // -----------------------------
        // タブ切替処理
        // -----------------------------
        document.getElementById('tab-all').onclick = () => {
            currentTab = "all";
            document.getElementById('tab-all').classList.add('active');
            document.getElementById('tab-read').classList.remove('active');
            displayShelf();
        };
        document.getElementById('tab-read').onclick = () => {
            currentTab = "read";
            document.getElementById('tab-read').classList.add('active');
            document.getElementById('tab-all').classList.remove('active');
            displayShelf();
        };

        // -----------------------------
        // 初期ロード
        // -----------------------------
        window.onload = () => {
            myShelf = loadMyShelf();
            displayShelf();
        };
    </script>
</body>
</html>
