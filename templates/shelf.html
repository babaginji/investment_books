<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>{{ shelf_name }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <h1>{{ shelf_name }}</h1>

    <h2>未読</h2>
    <div id="unread-container" class="books-container"></div>

    <h2>既読</h2>
    <div id="read-container" class="books-container"></div>

    <p><a href="{{ url_for('index') }}">トップに戻る</a></p>

    <script>
        const shelfName = "{{ shelf_name }}"; 
        const shelfBooksFromServer = {{ books|tojson }};
        let myShelf = [];

        // -----------------------------
        // localStorage から「私の本棚」を取得
        // -----------------------------
        function loadMyShelf() {
            const data = JSON.parse(localStorage.getItem("myShelf") || "[]");
            // read フラグが無い本には false を付与
            return data.map(book => {
                if (typeof book.read === 'undefined') book.read = false;
                return book;
            });
        }

        function saveMyShelf() {
            localStorage.setItem("myShelf", JSON.stringify(myShelf));
        }

        // -----------------------------
        // 本ボックス作成
        // -----------------------------
        function createBookDiv(book) {
            const bookDiv = document.createElement('div');
            bookDiv.className = 'book';

            // 星マーク（削除用）
            const star = document.createElement('span');
            star.className = 'star';
            star.textContent = '★';
            star.style.cursor = 'pointer';
            star.onclick = () => {
                myShelf = myShelf.filter(b => b.title !== book.title);
                saveMyShelf();
                displayShelf();
            };
            bookDiv.appendChild(star);

            // 画像
            const imgLink = document.createElement('a');
            imgLink.href = book.itemUrl;
            imgLink.target = '_blank';
            const img = document.createElement('img');
            img.src = book.image;
            img.alt = book.title;
            imgLink.appendChild(img);
            bookDiv.appendChild(imgLink);

            // タイトル・著者・価格
            const titleH3 = document.createElement('h3');
            titleH3.textContent = book.title;
            bookDiv.appendChild(titleH3);

            const authorP = document.createElement('p');
            authorP.textContent = '著者: ' + book.author;
            bookDiv.appendChild(authorP);

            const priceP = document.createElement('p');
            priceP.textContent = '価格: ¥' + book.price;
            bookDiv.appendChild(priceP);

            // 既読ボタン（absolute ではなく普通に配置）
            const readBtn = document.createElement('button');
            readBtn.textContent = book.read ? '未読に戻す' : '既読にする';
            readBtn.style.fontSize = '12px';
            readBtn.style.padding = '2px 4px';
            readBtn.style.marginTop = '4px';
            readBtn.onclick = () => {
                book.read = !book.read;
                saveMyShelf();
                displayShelf();
            };
            bookDiv.appendChild(readBtn);

            return bookDiv;
        }

        // -----------------------------
        // 本棚描画
        // -----------------------------
        function displayShelf() {
            const unreadContainer = document.getElementById('unread-container');
            const readContainer = document.getElementById('read-container');

            unreadContainer.innerHTML = '';
            readContainer.innerHTML = '';

            myShelf.forEach(book => {
                const bookDiv = createBookDiv(book);
                if (book.read) {
                    readContainer.appendChild(bookDiv);
                } else {
                    unreadContainer.appendChild(bookDiv);
                }
            });
        }

        // -----------------------------
        // 初期ロード
        // -----------------------------
        window.onload = () => {
            myShelf = loadMyShelf();
            displayShelf();
        };
    </script>
</body>
</html>
